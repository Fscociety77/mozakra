<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mozakra Notes</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #6f93db;
}

header {
  display: flex;
  justify-content: space-between;
  padding: 20px 60px;
  color: white;
}

nav a {
  color: white;
  margin-left: 20px;
  text-decoration: none;
  font-weight: bold;
}

.container {
  margin: 30px 40px;
  background: white;
  border-radius: 20px;
  padding: 20px;
}

.header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.add-btn {
  padding: 8px 14px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  background: #1976d2;
  color: white;
  font-weight: bold;
}

.note {
  border: 1px solid #ddd;
  border-radius: 14px;
  padding: 14px;
  margin-top: 12px;
}

.note small {
  color: gray;
}

.actions {
  margin-top: 10px;
}

.actions button {
  margin-right: 8px;
  border: none;
  padding: 6px 10px;
  border-radius: 8px;
  cursor: pointer;
}

.edit {
  background: #ff9800;
  color: white;
}

.delete {
  background: #f44336;
  color: white;
}

/* Modal */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  display: none;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: white;
  width: 400px;
  border-radius: 16px;
  padding: 20px;
}

.modal textarea {
  width: 100%;
  height: 120px;
  padding: 10px;
}

.modal-actions {
  text-align: right;
  margin-top: 10px;
}
</style>
</head>

<body>

<header>
  <h2>Mozakra</h2>
  <nav>
    <a href="sub_page.html">Home</a>
    <a href="chat.html">Mozakra AI</a>
    <a href="login.html">Logout</a>
  </nav>
</header>

<div class="container">
  <div class="header-row">
    <h2>Notes</h2>
    <button class="add-btn" onclick="openEditor()">+ Add Note</button>
  </div>

  <div id="notesList">Loading...</div>
</div>

<!-- Editor Modal -->
<div class="modal" id="editor">
  <div class="modal-content">
    <h3 id="editorTitle">New Note</h3>
    <textarea id="noteText"></textarea>
    <div class="modal-actions">
      <button onclick="closeEditor()">Cancel</button>
      <button onclick="saveNote()">Save</button>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API = "https://mozakra-production.up.railway.app/api";
const TOKEN_KEY = "token"; // ⚠️ عدل الاسم لو مختلف في مشروعك

const token = localStorage.getItem(TOKEN_KEY);

if (!token) {
  alert("Session expired. Please login again.");
  window.location.href = "login.html";
}

/* ================= HELPERS ================= */
function authHeaders() {
  // البحث عن التوكن في أماكن مختلفة
  const token =
    localStorage.getItem("token") ||
    localStorage.getItem("accessToken") ||
    localStorage.getItem("authToken") ||
    localStorage.getItem("jwt") ||
    localStorage.getItem("auth_token");

  if (!token) {
    console.error("No authentication token found");
    
    // تحقق إذا كان المستخدم في صفحة الدخول بالفعل
    if (!window.location.href.includes("login.html")) {
      alert("Your session has expired. Please login again.");
      window.location.href = "login.html";
    }
    
    throw new Error("No authentication token available");
  }

  console.log("Using token:", token.substring(0, 20) + "...");

  return {
    "Content-Type": "application/json",
    "Authorization": `Bearer ${token}`
  };
}

let editingId = null;

/* ================= LOAD NOTES ================= */
function loadNotes() {
  fetch(API + "/get-notes", {
    headers: authHeaders()
  })
  .then(res => {
    if (res.status === 401) throw new Error("Unauthorized");
    return res.json();
  })
  .then(data => {
    const list = document.getElementById("notesList");
    list.innerHTML = "";

    if (!data.notes || data.notes.length === 0) {
      list.innerHTML = "No notes yet.";
      return;
    }

    data.notes.forEach(note => {
      const div = document.createElement("div");
      div.className = "note";

      const content = note.description || "— No content —";
      const owner = note.ownerUsername || "You";

      div.innerHTML = `
        <p>${content}</p>
        <small>${owner}</small>
        <div class="actions">
          <button class="edit" onclick="editNote('${note._id}', \${content}\)">Edit</button>
          <button class="delete" onclick="deleteNote('${note._id}')">Delete</button>
        </div>
      `;

      list.appendChild(div);
    });
  })
  .catch(err => {
    console.error(err);
    document.getElementById("notesList").innerHTML =
      "Failed to load notes (Unauthorized)";
  });
}

/* ================= ADD / EDIT ================= */
function openEditor(text = "", id = null) {
  editingId = id;
  document.getElementById("noteText").value = text;
  document.getElementById("editorTitle").innerText =
    id ? "Edit Note" : "New Note";
  document.getElementById("editor").style.display = "flex";
}

function closeEditor() {
  editingId = null;
  document.getElementById("editor").style.display = "none";
}

function saveNote() {
  const text = document.getElementById("noteText").value.trim();
  if (!text) {
    alert("Note cannot be empty");
    return;
  }

  const url = editingId 
    ? `${API}/update-note/${editingId}` 
    : `${API}/add-note`;

  const method = editingId ? "PUT" : "POST";

  fetch(url, {
    method,
    headers: authHeaders(),
    body: JSON.stringify({ description: text })
  })
  .then(res => {
    if (!res.ok) throw new Error("Save failed");
    closeEditor();
    loadNotes();
  })
  .catch(err => {
    console.error(err);
    alert("Failed to save note");
  });
}

function editNote(id, text) {
  openEditor(text, id);
}

/* ================= DELETE ================= */
function deleteNote(id) {
  if (!confirm("Delete this note?")) return;

  fetch(`${API}/delete-note/${id}`, {
    method: "DELETE",
    headers: authHeaders()
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert("Note deleted successfully");
      loadNotes(); // إعادة تحميل القائمة
    } else {
      alert("Failed to delete note");
    }
  })
  .catch(err => {
    console.error("Error deleting note:", err);
    alert("Server error");
  });
}

/* ================= INIT ================= */
loadNotes();
</script>

</body>
</html>